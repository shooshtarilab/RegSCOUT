![logo](https://github.com/shooshtarilab/RegSCOUT/blob/main/images/RegSCOUT_logo.png)

# RegSCOUT (<ins>Reg</ins>ulatory <ins>S</ins>ingle <ins>C</ins>ell <ins>O</ins>mics for <ins>U</ins>nravelling <ins>T</ins>rait-Loci)
RegSCOUT is a computational pipeline that integrates disease-associated SNPs, identified through genome-wide association studies (GWAS), with scATAC-seq, Hi-C, eQTL, TF position frequency matrices (PFMs), scRNA-seq, and GENCODE gene annotation data. Through this comprehensive integrative approach, RegSCOUT prioritizes putative gene regulatory networks relevant to the pathogenesis of complex diseases. We have made RegSCOUT into an executable docker application for ease of use; however, RegSCOUT can also be run in bash, example bash scripts can be found on the github page in the bash_scripts folder. While this README will provide a general overview of the pipeline and how it can be run, <ins>it is highly recommended that users read the more comprehensive user manual on this github before using RegSCOUT</ins> (RegSCOUT_User_Manual.pdf).

## Required R version and libraries:
RegSCOUT can be run on R versions 4.4.x and 4.5.x. It requires these libraries: tools, Seurat, Signac, GenomicRanges, genetics.binaRies, R.utils, atSNP, TFBSTools, JASPAR2024, stringr, circlize, ComplexHeatmap, R.utils, monocle3, cicero, Repitools, reshape2, dplyr, purrr, BSgenome.Hsapiens.UCSC.hg19, BSgenome.Hsapiens.UCSC.hg38, rtracklayer, data.table, writexl, tidyr, and tibble. <ins>Monocle3 must be installed prior to installing cicero</ins> (cicero analysis will not run properly if not). Cicero should be installed following instructions found in this link: https://cole-trapnell-lab.github.io/cicero-release/docs_m3/. 

## Note about genome builds:
When using RegSCOUT please ensure that all files provided to this pipeline are in the same genome build. E.g., PLINK bfiles (.bed, .bim, .fam), GWAS summary statistics, GWAS lead SNPs, GWAS locus region information, fine-mapped GWAS data, scATAC-seq datasets, Hi-C datasets, eQTL datasets, histone mark results datasets, and GENCODE gene information. RegSCOUT does not perform the lifting over of genome coordinates from one genome annotation version to another, this must be done prior to use of the pipeline. 

## Important Notes When Using RegSCOUT
1.	All directories specified in parameters passed to RegSCOUT should end with “/”. 
2.	Downstream stages of the pipeline will not work if the --mode parameter is not used (see sections 1.5, 4, and 5 of this manual). Please ensure you select a mode for RegSCOUT and provide scATAC-seq data to the pipeline.
3.	Please note that case (lower/upper case) matters in all aspects of this pipeline (parameters, column names for input files, etc.). Please keep this in mind when using parameters and creating input files, for example. 
4.	When providing numerical values to parameters, do not incorporate commas or spaces for thousands, e.g., use 100000 not 100,000.
5.	All chromosome numbers provided in files to RegSCOUT must be of the following naming convention 'chr' + 'number' (no space between). For example: chr8.
6.	Please see below explanation of mandatory RegSCOUT parameter:
| Parameter | Purpose and Potential Values | Default Value |
| --------- | ---------------------------- | ------------- |
| --output_dir | This parameter should specify the directory in which the user would like all outputs to be stored by RegSCOUT. This parameter should always be defined by the user. An ‘images’ folder will be created in this directory to store all figures generated by the pipeline. If this folder is already present in this directory, it will be overwritten. | No default, must be set by user. |

7.  Please see below explanations of important terms:
| Term | Definition |
| ---- | ---------- |
| Effect-SNPs | Fine-mapped SNPs that significantly influence the binding affinity of one or more TFs. |
| Risk-Mediating Peaks | Open chromatin regions in which one or more effect-SNPs colocalize (fall in the region). |

## Pipeline Overview
![Pipeline Overview](https://github.com/shooshtarilab/RegSCOUT/blob/main/images/Workflow_schematic.png)

Above is a general overview of the RegSCOUT workflow. In the following sections of this README, descriptions of parameters, inputs, and outputs, for each step, will be provided. Although the steps shown in the figure are numbered sequentially from 1-8, many are optional and dependent on what data is available to the user.
- If --mode *peak_table* is requested, step 3 will not be run. 
- If the --finemap parameter is not specified, steps 1 & 2 will not run. 
- If the --hic_analysis parameter is not specified, step 5b will not run.
- If the --eqtl_analysis parameter is not specified, step 5c will not run.
- If the --histone_mark_analysis parameter is not specified, step 6 will not run.
- If the --tf_expr_analysis parameter is not specified, step 7 will not run.


*All directories specified in parameters should end with "/".

**Please note that case (lower/upper case) matters in all aspects of this pipeline (parameters, column names for input files, etc.).

***When providing numerical values to parameters, do not incorporate commas or spaces for thousands, e.g., use 100000 not 100,000.

****All chromosome numbers provided in files to RegSCOUT must be of the following naming convention 'chr' + 'number' (no space between). For example: chr8.




## Main Parameters:
### --mode: 
This parameter should be used to choose the mode of operation of the pipeline based on input type. If a scATAC-seq Seurat object is provided, this option should be set to ATAC_obj (i.e., --mode ATAC_obj). If a peak and cell type table and peak-peak interaction table are used this mode should be set to peak_table (i.e., --mode peak_table).

### --output_dir: 
This parameter should be used for setting the working directory (the directory address should end with "/"). **This parameter should always be set when using RegSCOUT regardless of the value of --finemap or --mode**. All the output and intermediate files of the pipeline are generated in this directory. If running the pipeline with --mode peak_table, the peak-by-cell and peak-peak interaction tables of the pipeline should be provided in this directory.

## Fine-mapping Requested by User (--finemap Y; Steps 1 and 2)
See required parameters in table of all parameters.

### <ins>Required Files</ins>

### GWAS Summary Statistics
The path to the summary statistics file should be specified using --sum_stats_dir. This file must be tab separated and contain at least these 4 following columns (note that RegSCOUT is case sensitive): SNP (containing SNP rsIDs), CHR (chromosome of the SNP), POS (position of SNP on chromosome), and P (p-value of association of SNP to disease). The following columns are not necessary but will be used by RegSCOUT if present: A1 (reference allele of SNP), A2 (alternative allele of SNP), MAF (minor allele frequency of SNP), and N (sample size). 

If a sample size column is present in the summary statistics, the --sample_num parameter should be set to *present*; however, if it is not and the user is not able to find sample size for each SNP, the overall sample size of the GWAS study should be provided using the --sample_num parameter (e.g., --sample_num 190000). 

If one of A1, A2, or MAF are missing from the GWAS summary statistics file, each of these columns will be filled in using Plink2 and its required bfiles. More information regarding this can be found in the Plink bfiles section. 

### GWAS Lead SNPs
The path to this file should be specified using --lead_snp_dir. This file must be tab separated (.txt or .tsv) if containing more than one column; however, only one column in this file is necessary for the pipeline to run: SNP (containing lead SNP rsIDs). Any additional columns provided will be included in the new_lead_snps.txt output file described in the "Output Files" section. 

### Plink bfiles
The path to these files are specified by the combination of the --snp_ref_dir and --population parameters. The file suffixes are not required in the file path, thus an example file path used by RegSCOUT is '/user/bin/EUR'. These are the .bim, .bed, .fam files required to run Plink2 to fill in reference/alternative allele as well as minor allele frequency information. These files will also be used to calculate LD values and group SNPs into loci. These files in hg19 can be downloaded from here: https://mrcieu.github.io/gwasglue/. Users can also provide bfiles that they have generated, in hg38, or for the specific group they want to study.

### <ins>Output Files</ins>

### Plink2.afreq
A file output by Plink2 which provides SNP information including reference and alternative alleles and minor allele frequency. Will not be output if all of A1, A2, and MAF columns are present in GWAS summary statistics.

### new_lead_snps.txt
If the A1, A2, or MAF column in missing in the GWAS summary statistics, this file will contain only those lead SNPs that were found in Plink2, which subsequent analyses will be performed on. If the three columns were present this new_lead_snps.txt file should not be different from the lead SNP file provided initially to RegSCOUT.

### loci_info.txt
File containing information on each locus region created by RegSCOUT. The columns of this file are chunk (the locus number), lead_snp (the lead SNP of the locus), locus_chr (the chromosome the locus is found on), locus_start (start position of the locus), and locus_end (end position of the locus). 

### final_gwas_data.txt
A tab-separated file organized by increasing locus number. This file is provided to fgwas for fine-mapping. There are 9 columns: SNPID (the rsID of a SNP), CHR (the chromosome the SNP is found on), POS (the position of the SNP on the chromosome), Z (the associated Z-score of the SNP), F (the SNP's minor allele frequency), N (sample size), SEGNUMBER (locus number), A1 (reference allele of SNP), A2 (alternative allele of SNP). 

### gwas_CI.txt
A tab-separated file which contains the results of fine-mapping and filtering for CI_thr. SNPs on sex chromosomes and with PPA values <= 0.01 have also been filtered out. These are the credible interval SNPs.

## Fine-mapping Already Conducted (--finemap not used)

### <ins>Required Files</ins>

### Fine-mapping Results File
The path to this file must be specified by the --ci_gwas_dir parameter. If fine-mapping has already been conducted by the user, a file that contains the results of fine-mapping is required to be provided by the user. This file must contain credible interval SNPs where for each locus, the smallest number of SNPs whose cumulative PPAs add up to a certain threshold is provided (e.g., 0.99 or 0.95, this threshold is up to the user). This identification of credible interval SNPs will not be conducted by RegSCOUT if the --finemap parameter is not used. The file does not have a specific naming convention that it must follow, but must be a tab separated file (.txt or .tsv). This file must have at least 7 columns labelled: 'id' (SNP rsID), 'pos' (SNP bp position), 'chr' (SNP chromosome), 'chunk' (SNP locus number), 'PPA' (SNP associated PPA), 'a1' (SNP reference allele), and 'a2' (SNP alternative allele). Other columns that are optional but if present will be included in the final tables generated are: 'lead_snp' (the lead SNP of the SNP's locus), 'locus_chr' (locus chromosome number e.g., chr8 - chromosome numbers must follow this naming convention), 'locus_start' (start position of the locus), and 'locus_end' (end position of the locus).

## Mode set to peak_table (--mode peak_table; Steps 4 and 5)
The *peak_table* option should only be used if the user has already identified cell type-specific open chromatin regions and has already run cicero on their data to establish peak to peak links. If the user has specified this option for RegSCOUT, this means that RegSCOUT will not be identifying cell type-specific open chromatin regions based on a certain threshold (e.g., a region must be open in 10% of cells of a cell type). RegSCOUT will also not be running cicero analysis to link open chromatin regions to each other as that must have already been done by the user. Instead, the user must provide both a peak-cell type table and cell type-specific co-accessibility tables (output of cicero) to RegSCOUT **in the directory specified by the --output_dir parameter**. More information on these tables and their formats can be found below.

### <ins>Required Files</ins>

### Peak-Cell Type Table
The path to this file need not be specified as RegSCOUT will look for this file in the directory defined by the --output_dir parameter. This file must be a tab separated file (.tsv) named **cell_peak.tsv**. The table should have four columns "chr", "start", "end", and "cell_types". Each row will represent one region of chromatin that was identified to be open. The "cell_types" column in each row will be a comma separated list of all cell types in which the chromatin region on that row was identified to be open. In the 'cell_types' column, there should be no spaces after each comma. 

Example peak-cell type table:
| chr | start | end | cell_types | 
| ---- | ----- | --- | -------------- | 
| chr1 | 123 | 1000 | plasma_cells,memory_b_cells | 
| chr11 | 2000 | 2600 | naive_CD8_T_cells,naive_CD4_T_cells | 
| chr18 | 1 | 678 | classical_monocytes,intermediate_monocytes,nonclassical_monocytes | 

### Cell Type-Specific Co-Accessibility Tables
The path to these files need not be specified as RegSCOUT will look for these files in the directory defined by the --output_dir parameter. These should be the output of cicero after filtering for a certain co-accessibility threshold. RegSCOUT will not perform this co-accessibility filtering if --mode *peak_table* was selected. There will be one table for each of the cell types investigated. The names of each cell type-associated file should follow this naming convention: [cell type name].filtered_coaccessible_sites4s.txt. These tables should be tab-separated and should have three columns named "Peak1", "Peak2", and "coaccess" (coaccessibility value between peak1 and peak2 calculated by cicero). The Peak1 and Peak2 columns should contain underscore-separated locations of open chromatin regions (e.g., chr1_1000_1600). 

Example cell type-specific co-accessibility table:
| Peak1 | Peak2 | coaccess | 
| ---- | ---- | ----- | 
| chr1_1000_1600 | chr1_2000_2600 | 0.13 |
| chr3_3000_4000 | chr3_5000_5500 | 0.27 |

### GENCODE Gene Annotation File
The path to this file should be specified using the --gencode_dir parameter. The <ins>path</ins> to the GENCODE gene annotation file downloaded from the [GENCODE website](https://www.gencodegenes.org). Users should download the appropriate .gff3 file in the genome build that all other files are in, that the user is hoping to have RegSCOUT analyze. The .gff3 file should be a comprehensive gene annotation file. RegSCOUT will filter this gene annotation file for specifically the protein coding gene transcripts present and use those transcripts for subsequent analyses, i.e., defining promoter regions.

### JASPAR TF PFM File
The path to this file should be specified using the --jaspar_mtx_dir parameter. To create this file, the user must download position frequency matrices (PFMs) from [the JASPAR website](https://jaspar.elixir.no) and place them into a single file. In conducting TF analysis, this pipeline uses the JASPAR TF binding profile database. This <ins>path</ins> to this file can be provided using this parameter. Alternatively, if the user would prefer not to upload such a file, this parameter can be set to none (i.e., --jaspar_mtx none). RegSCOUT in this case will obtain PFMs from JASPAR using the [JASPAR2024 library](https://bioconductor.org/packages/release/data/annotation/html/JASPAR2024.html). 

### <ins>Output Files</ins>

### atSNP_10runs_results.RDS
An RDS file containing the results of 10 runs of the ComputePValues function of the atSNP R package which identifies the impact of SNPs on TF binding affinities. 

### Ci_effect_SNPs.txt
A tab-separated file containing all identified SNPs significantly impacting the binding affinity of at least one TF (<ins>termed Effect-SNPs</ins>), and their associated TFs. This file has 9 columns: 'SNP' (the rsID of a SNP), 'CHR' (the chromosome the SNP is found on), 'Pos' (the position of the SNP on the chromosome), 'Locus' (locus number), 'TF' (TF whose binding affinity was significantly impacted by SNP), 'Raw_P_value' (p-value before FDR correction), 'FDR_corr_P_value' (p-value after FDR correction), 'log_like_ratio' (the log likelihood ratio quantifying the impact of the alternative allele of a SNP on TF binding affinity compared to the reference allele), and 'ppa' (PPA of SNP).

### peak_cluster_matrix.txt
A binary matrix that contains cell types as columns and open chromatin regions that co-localize with at least one effect-SNP as rows (<ins>these regions are termed risk-mediating peaks</ins>). A '1' indicates that that an RMP was found in a specified cell type whereas a '0' means it was not. This text file is tab separated.

### risk_regions_ppa.txt
Table that provides more information on risk-mediating peaks found by RegSCOUT. It has three columns: 'region' (the RMP), 'cell' (the cell types in which the open chromatin region was found to be an RMP), and sumPPA (the sum of the PPAs of all effect-SNPs that fall in that RMP).

### cell_peak.svg
A visual representation of risk_regions_ppa.txt. This heatmap shows risk-mediating peaks on the y-axis and cell types on the x-axis. A heatmap square shaded in red indicates that a certain risk-mediating peak was found in a certain cell type whereas if a square is shaded in white, that RMP was not found in that cell type. The bar on the right of this heatmap with shades of purple shows the summed PPA (sumPPA) value obtained for each risk-mediating peak.

### TF_cluster_matrix.txt
A binary matrix that contains cell types as columns and TF-SNP pairs as rows. If a TF-SNP pair was found relevant to a certain cell type it would obtain a value of '1', otherwise it would obtain a value of '0'.

### risk_regions_ratio.txt
Table providing information on risk-mediating peaks and their associated effect-SNPs. This table has 4 columns: 'region' (a risk-mediating peak), 'cell' (the cell type in which this effect SNP was found to fall in this risk-mediating peak), 'TFSNP' (a TF-SNP pair identified by atSNP), and 'log_like_ratio (the log likelihood ratio describing an effect-SNPs effect on a TF's binding affinity).

### cell_snp_tf.svg
A visual representation of risk_regions_ratio.txt specific to TF-SNP pairs. This heatmap shows TF-SNP pairs on the y-axis and cell types on the x-axis. A heatmap square shaded in blue indicates that a certain TF-SNP pair was found relevant to a certain cell type whereas if a square is shaded in white, that TF-SNP pair was not found relevant to that cell type. The bar on the right of this heatmap with shades of orange shows the log likelihood ratio value obtained for each TF-SNP pair.

### direct_rmp_gene_overlaps.txt
This is a table of all risk-mediating peak and gene promoter (as defined by GENCODE) overlaps identified by RegSCOUT, output as a tab separated text file. There are 4 columns: 'RMP' (the risk-mediating peak), 'Promoter' (the promoter region defined using GENCODE TSSs, and --prom_th_up and --prom_th_down parameters defined by the user), 'Gene' (the gene associated with that promoter), and 'Cell_Type' (the cell type in which that risk-mediating peak was identified).

### cic_peak_interact_gene.txt
Table that shows links between RMPs and their target genes using peak-peak links identified by cicero, output as a tab separated text file. This table has 6 columns: 'Peak1' (A risk-mediating peak), 'Peak2' (The peak that co-localized with a gene's promoter), 'coaccess' (the coaccessibility value calculated by cicero between Peak1 and Peak2), 'Promoter' (the promoter region defined using GENCODE TSSs, and --prom_th_up and --prom_th_down parameters defined by the user), 'Gene' (the gene associated with that promoter), and 'Cell_Type' (the cell type in which this RMP-gene link was identified).

### cell_gene_matrix.txt
A binary matrix that shows genes as columns and cell types as rows. A '1' indicates that a gene was prioritized in a cell type according to risk-mediating peak and gene promoter overlap with cicero results, or by direct co-localization of a risk-mediating peak with a gene's promoter. A '0' indicates that a gene was not prioritized in a cell type according to those criteria. 

### Gene_promoter_matrix.txt
A binary matrix that shows cell types as columns and RMP-gene pairs as rows. This matrix is specific to those genes whose promoters were overlapped by an RMP. A '1' indicates that that RMP-gene pair was identified in that cell type, whereas a '0' indicates that RMP-gene pair was not found relevant to that cell type. 

### Gene_enhancer_matrix.txt
A binary matrix that shows cell types as columns and RMP-gene pairs as rows. This matrix is specific to the case where cicero identified a relationship between an RMP and a gene's promoter where the RMP did not overlap the gene's promoter. A '1' indicates that that RMP-gene pair was identified in that cell type, whereas a '0' indicates that RMP-gene pair was not found relevant to that cell type. 

## Mode set to ATAC_obj (--mode ATAC_obj; Steps 3, 4, and 5)
The *ATAC_obj* option should be used when the user has a scATAC-seq dataset that they would like RegSCOUT to use to identify risk-mediating open chromatin regions and run cicero analysis. More information on how this scATAC-seq dataset should be formatted can be found below. In this case, RegSCOUT will identify open chromatin regions in the scATAC-seq dataset based on a threshold defined using the --peak_th parameter. RegSCOUT will also run cicero analysis according to the user's specifications using the --cic_genomic_window and --coaccess_th parameters. 

### <ins>Required Files</ins>
The required files when using --mode ATAC_obj are different from those required for --mode peak_table with the exception of the GENCODE gene annotation file, which is still required and the path to this file should still be set with the --gencode_dir parameter. 

### scATAC-seq Seurat Object
The path to the scATAC-seq Seurat object should be provided using the --seurat_obj_dir parameter. The provided Seurat object should have an Assay named "peaks" which holds a chromatin assay object created from the counts matrix of the scATAC-seq experiment. In addition, cell type labels should be provided as cell identities in the Seurat object (and accessible using the Idents() function of Seurat). This article provides more information on how to establish cell identities/class labels (https://satijalab.org/seurat/articles/essential_commands.html). The seurat object can be provided to RegSCOUT as either an RDS or RData file, both will work with the pipeline.

### JASPAR TF PFMs and GENCODE Gene Annotation

### <ins>Output files</ins>

### cell_peak.xlsx 
Table that provides genomic locations of peaks considered open in certain cell types (i.e., those that met the CI_thr). This table will have four columns: chr (the chromosome the open chromatin region is found on), start (start position of open chromatin region), end (end position of open chromatin region), and cell sub-types (all cell types in which a peak was considered open).

### [cell type name].filtered_coaccessible_sites4s.txt
These files are the results of cicero analysis. They will have three columns: Peak1, Peak2, and coaccess (the co-accessibility value calculated between Peak1 and Peak2). Only peak-peak interactions with co-accessibility > 0.05 will be found in these files. One file will be output for each cell type in the scATAC-seq data. 

### cell_gene.png
A visual representation of cell_gene.csv. This heatmap shows cell types on the y-axis and genes on the x-axis. A heatmap cell shaded in red indicates that a certain gene was prioritized to a certain cell type whereas if a cell is shaded in white, that gene was not found relevant to that cell type according to cicero.

## If mode is set to peak_table (--mode peak_table)

### <ins>Required parameters</ins>
Parameters required for --mode peak_table are nearly the same as those required for --mode ATAC_obj; the difference is that the --seurat_obj and --peak_th parameters are no longer necessary. The peak and cell type table and peak-peak interaction tables should be placed in the directory specified by --output_dir. 

### <ins>The peak and cell type table, and peak-peak interaction tables</ins>
This peak and cell type table should be named cell_peak.xlsx and should have three columns named "chr", "start", "end" (chromosome, start and end of the open chromatin regions), and a column named “cell sub-types” which represents the cell types in which a peak is considered open. Multiple cells should be comma-separated in this column. There should be one peak-peak interaction table for each cell type to be studied. The names of their associated files should be [cell type name].filtered_coaccessible_sites4s.txt. These tables should be tab-separated and should have three columns named "Peak1", "Peak2", and "coaccess" (coaccessibility value between peak1 and peak2 calculated by cicero). The Peak1 and Peak2 columns should contain underscore-separated locations of open chromatin regions (e.g., chr1_1000_1600). Examples of a peak and cell type table and of a peak-peak interaction table are shown below. 

### <ins>Output files</ins>
The output for this mode would be the same as those listed in --mode ATAC_obj; the difference is that cell_peak.xlsx and [cell type name].filtered_coaccessible_sites4s.txt are not output as they are required as inputs when --mode is set to peak_table. 
